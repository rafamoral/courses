---
title: "Introduction to Generalized Linear Models"
author: "Dr Rafael de Andrade Moral"
date: ""
output:
  beamer_presentation:
    colortheme: orchid
    fonttheme: professionalfonts
    highlight: haddock
    includes:
      in_header: mystyle.tex
    theme: Berlin
fontsize: 0.1cm
---

## Outline

\footnotesize

\begin{itemize}
\item The normal model: A recap (bit of history on GLMs)
\item Models for binary data (odds, odds ratio, logit link, deviance)
\item Models for binomial data (probit, cloglog --end of day 1)
\item Models for multinomial data (generalized logit model)
\item Models for count data (Poisson, offset, hnp --end of day 2)
\item Extensions: overdispersion models (quasi-Poisson, Negbin, quasi-binomial, betabinomial)
\item Extensions: zero-inflated models (ZIP, ZINB, hurdle --end of day 3)
\end{itemize}


## The normal model: A recap







## \textit{Diaphorina citri} Mortality

\footnotesize

\begin{itemize}
\item The Citrus psyllid \textit{Diaphorina citri} (Hemiptera: Psyllidae) is a vector of Huanglongbing, known as greening disease
\item D'Alessandro (2014, unpublished data, private communication) conducted a completely randomized experiment
\end{itemize}

\centering
\includegraphics[width=.5\textwidth]{dcitri.jpg}

## \textit{Diaphorina citri} Mortality

\footnotesize

\begin{itemize}
\item Two fungus species: \textit{Beauveria bassiana} and \textit{Isaria fumosorosea}
\item Five conidia concentrations ($10^4$, $10^5$, $10^6$, $10^7$ and $10^8$ conidia per ml) 
\item Each experimental unit consisted of approximately 20 \textit{D. citri} insects placed on \textit{Citrus limonia} plants
\item Insects pulverized with solutions and after 10 days the number of insects dead due to fungus infection and total number of dead insects were observed
\item Note that the conidia concentrations are obtained via successive dilutions, and hence small variations in the no. of conidia per ml may contribute additional variability to the data
\end{itemize}

## \textit{Diaphorina citri} Mortality

\centering
\includegraphics[width=\textwidth]{table1.png}

## \textit{Diaphorina citri} Mortality

\centering
\includegraphics[width=.8\textwidth]{motivation.pdf}

## Statistical Modelling

\LARGE

What is Statistical Modelling?

## Statistical Modelling

\LARGE

What is a Statistical Model?

## Statistical Modelling

\LARGE

It's all about Probability!

## Statistical Modelling

Building blocks

\begin{enumerate}
\item Response variable ($Y$)
\item Probability distribution
\item Parameters of interest \pause $\leftarrow$ covariates / predictors
\end{enumerate}

## Statistical Modelling

\small

- $Y_i$ is a response variable associated with experimental or observational unit $i$
- We *assume* it comes from a certain probability distribution with pmf/pdf $f$ and vector of parameters $\boldsymbol{\theta}$
- In general, one of the parameters in $\boldsymbol{\theta}$ is the mean of the distribution
- We also have predictors $x_i$ we are interest in studying
- We may link it to a parameter of interest, typically the mean of the distribution

## Statistical Modelling

\footnotesize

Example

\centering
\includegraphics[width = .6\textwidth]{ex1.png}

## Statistical Modelling

\footnotesize

Example

\begin{eqnarray*}
Y_i & \sim & \mbox{N}(\mu_i, \sigma^2) \\
\mu_i & = & \beta_0 + \beta_1x_i
\end{eqnarray*}

\pause

What about

- normality of residuals?
- homogeneity of variances?

This *only* makes sense for the model above!

## Statistical Modelling

\footnotesize

What if you had

\centering
\includegraphics[width = .6\textwidth]{ex2.png}

## Statistical Modelling

\footnotesize

Maybe then you'd assume

\begin{eqnarray*}
Y_i & \sim & \mbox{N}(\mu_i, \sigma^2_i) \\
\mu_i & = & \beta_0 + \beta_1x_i \\
\log\sigma^2_i & = & \gamma_0 + \gamma_1x_i
\end{eqnarray*}

No homogeneity of variances here!

## Statistical Modelling

\LARGE

$Y$ can be assumed to have *any* distribution

\pause

Why is the normal distribution used to often then?

## Statistical Modelling

\footnotesize

$Y_i$ is a count variable

\begin{eqnarray*}
Y_i & \sim & \mbox{Poisson}(\mu_i) \\
\log\mu_i & = & \beta_0 + \beta_1x_i
\end{eqnarray*}

This automatically yields

\begin{eqnarray*}
\mbox{E}[Y_i] &=& \mu_i \\
\mbox{Var}(Y_i) &=& \mu_i
\end{eqnarray*}

No homogeneity of variances here also! And definitely residuals aren't expected to be normal!

## Statistical Modelling

\footnotesize

$Y_i$ is a discrete proportion

\begin{eqnarray*}
Y_i & \sim & \mbox{Binomial}(m_i,\pi_i) \\
\displaystyle\log\left(\frac{\pi_i}{1-\pi_i}\right) & = & \beta_0 + \beta_1x_i
\end{eqnarray*}

This automatically yields

\begin{eqnarray*}
\mbox{E}[Y_i] &=& m\pi_i \\
\mbox{Var}(Y_i) &=& m\pi_i(1-\pi_i)
\end{eqnarray*}

Do you think variances are homogeneous here? Of course not!!

## Statistical Modelling

Can you complicate this further?

\pause

Yes, yes and YES!

- Mixture models
- Hierarchical models
- Joint models
- Multivariate models
- ...

## Statistical Modelling

\small

- The normal, Poisson and binomial models are examples of GLMs
- They have the same building blocks, the probability distributions share similar properties and estimation is smart, elegant, quick and easy to implement!
- Each building block has a specific name in the GLM literature
- Let's have a look

## Generalized Linear Models

\footnotesize

\begin{itemize}
\item A GLM has three components:
\footnotesize
\begin{enumerate}
\item \textbf{Random component} - the distribution of the data
\begin{eqnarray*}
Y_{ij}\sim\mbox{Binomial}(m_{ij},\pi_{ij}),
\end{eqnarray*} \vspace{-1cm}
\begin{eqnarray*}
i = 1,2 \mbox{ (fungus species)}, j=1,2,3,4,5 \mbox{ (concentrations)}
\end{eqnarray*}
\item \textbf{Systematic component} - the linear predictor
\begin{eqnarray*}
\eta_{ij} = \beta_{0i} + \beta_{1i}x_{ij}
\end{eqnarray*}
\item \textbf{Link function} - function linking the random to the systematic component
\begin{eqnarray*}
\eta_{ij} = \displaystyle\log\frac{\pi_{ij}}{1-\pi_{ij}}
\end{eqnarray*}
\end{enumerate}
\end{itemize}

## Generalized Linear Models and Overdispersion

\footnotesize

\begin{itemize}
\item Outcomes of interest in Entomology are often in the form of counts or proportions
\item As a first step we might analyse these using standard Poisson and binomial models
\item However, in general, the data are overdispersed: a larger variance than assumed by these simple standard models
\item Remember:
\end{itemize}

\begin{eqnarray*}
Y \sim \mbox{Poisson}(\mu), & \mbox{E}[Y]=\mu, \mbox{Var}(Y)=\mu \\
Y \sim \mbox{Binomial}(m,\pi), & \mbox{E}[Y]=m\pi, \mbox{Var}(Y)=m\pi(1-\pi) \\
\end{eqnarray*}

## Overdispersion

\footnotesize

\begin{itemize}
\item Causes of overdispersion: \textbf{variability of experimental material} (e.g. individual tolerance to chemical), \textbf{correlation between individual responses} (e.g. batches), \textbf{cluster and multistage sampling}, \textbf{aggregation}, \textbf{omitted unobserved variables}
\item Consequences of not taking into account overdispersion include: concluding an effect is significant when it is not, incorrect uncertainty when making prediction, misleading inference on model parameters
\end{itemize}

## Assessing goodness-of-fit

\footnotesize
\vspace{-.15cm}

- Two important quantities are the \color{blue}\textbf{deviance} \color{black} $$D=2\displaystyle\sum_{i=1}^n\left\{y_i\log\left(\frac{y_i}{\hat\mu_i}\right)+(m_i-y_i)\log\left(\frac{m_i-y_i}{m_i-\hat\mu_i}\right)\right\}$$ and the \color{blue}\textbf{Pearson $X^2$ statistic} \color{black} $$X^2=\displaystyle\sum_{i=1}^n\frac{(y_i-\hat\mu_i)^2}{\hat\mu_i\left(1-\frac{\hat\mu_i}{m_i}\right)}$$ \vspace{-.15cm}
- Both have an approximate $\chi^2$ distribution on $n-p$ degrees of freedom \vspace{.1cm}
- For a well-fitting (adequate) model, we would expect these statistics to be consistent with the $\chi^2_{n-p}$ distribution at a significance level $\alpha$, i.e. we would require $D<\chi^2_{n-p;(1-\alpha)}$ or $X^2<\chi^2_{n-p;(1-\alpha)}$ \vspace{.1cm}
- More informally, we may simply check to see if $D\approx n-p$ or $X^2\approx n-p$ \vspace{.1cm}
- We may also perform graphical residual analyses, such as by constructing a normal QQ-plot with simulation envelope (Moral et al., 2017)

## Fitting the Binomial GLM

\footnotesize

\centering

\begin{tabular}{lccc}
\hline
Source & df & Deviance & p-value \\
\hline
Concentration & 1 & 128.14 & $<0.0001$ \\
Species     &  1   & 36.64  & $<0.0001$ \\
Concentration $\times$ Species &  1   & 7.227   & 0.0072 \\
\hline
\end{tabular}

\begin{itemize}
\item Residual deviance: 56.25 on 26 df
\item Pearson $X^2$: 62.99
\item $\chi^2_{26;0.95}=38.89$
\end{itemize}

## Assessing Goodness-of-fit

\scriptsize

"The ability of the human eye to find patterns in scatters of points is one strong reason for the use of graphical methods." (A.C. Atkinson, 1985)

\pause

- Normal probability plots
- Ordered values vs. expected order statistics of a normal distribution $\Phi^{-1}\left(\frac{i-\frac{3}{8}}{n+\frac{1}{4}}\right)$ \vspace{-1cm}

\pause

\centering
\includegraphics[width=.5\textwidth]{hnp1.pdf}

## Checking for Normality

\scriptsize

"The ability of the human eye to find patterns in scatters of points is one strong reason for the use of graphical methods." (A.C. Atkinson, 1985)

- Normal probability plots
- Ordered values vs. expected order statistics of a normal distribution $\Phi^{-1}\left(\frac{i-\frac{3}{8}}{n+\frac{1}{4}}\right)$ \vspace{-1cm}

\centering
\includegraphics[width=.5\textwidth]{hnp2.pdf}

## Expected Shapes

\Wider[3em]{
\vspace{-.75cm}
\centering
\includegraphics[width=\textwidth]{qq1.pdf}
}

## Expected Shapes

\Wider[3em]{
\vspace{-.75cm}
\centering
\includegraphics[width=\textwidth]{qq2.pdf}
}

## Building a Simulated Envelope

\small

- Fit model and obtain diagnostics in order
- Simulate 99 response variables using same model matrix, error distribution and fitted parameters
- Refit the model to each simulated sample and obtain the same diagnostics, again, sorted values
- Compute desired percentiles (e.g. 2.5\% and 97.5\%) to form the envelope

## Without Simulated Envelope

\Wider[3em]{
\vspace{-.75cm}
\centering
\includegraphics[width=\textwidth]{qq3.pdf}
}

## With a Simulated Envelope

\Wider[3em]{
\vspace{-.75cm}
\centering
\includegraphics[width=\textwidth]{qq5.pdf}
}

## Half-normal Plots with a Simulated Envelope

\scriptsize

\begin{itemize}
\item We often use a half-normal distribution instead of a normal distribution to produce this type of plot -- better visualisation for small samples
\item Only difference -- use the absolute value of the model diagnostics (and also a small correction for the approximate order statistics)
\item For our example:
\end{itemize}

\vspace{-.5cm}

\centering
\includegraphics[width=.6\textwidth]{hnp0.pdf}

## Overdispersion Models

\footnotesize

\begin{itemize}
\item There are various extensions to the basic GLM framework to allow for overdispersion, such as
\begin{enumerate}
\footnotesize
\item Quasi-likelihood -- replace the mean-variance function of the original model by a more general form, e.g.
\begin{eqnarray*}
\mbox{Var}(Y)=\phi m\pi(1-\pi); \mbox{Var}(Y)=\phi\mu
\end{eqnarray*}
\item Two-stage models -- allow a model parameter to vary according to some distribution, e.g. the beta-binomial model, or the Poisson-gamma model (negative binomial)
\begin{eqnarray*}
Y|P\sim\mbox{Binomial}(m,P), & P\sim\mbox{Beta}(a,b) \\
Y|T\sim\mbox{Poisson}(T), & T\sim\mbox{Gamma}(\theta,\lambda)
\end{eqnarray*}
\item Mixed models -- include an additive random effect in the linear predictor, e.g. logistic-normal model, Poisson-normal model
\begin{eqnarray*}
\eta_i=\beta_0+\beta_1x_{1i}+\ldots+\beta_px_{pi}+z_{i}, Z_i\sim\mbox{N}(0,\sigma^2)
\end{eqnarray*}
\item Zero-inflated models, zero-truncated (hurdle) models
\item Marginal models, many other distributions and/or extended models
\end{enumerate}
\end{itemize}

## Back to our example

\centering
\includegraphics[width=\textwidth]{6diaphorina_hnp.eps}

\footnotesize

- How to choose a model? -- \textbf{Biological interpretation}

## Fitting the Logistic-normal Model

\footnotesize

\centering

\begin{tabular}{lccc}
\hline
Source & df & Deviance & p-value \\
\hline
Concentration & 1 & 33.32 & $<0.0001$ \\
Species     &  1   & 12.55  & $0.0004$ \\
Concentration $\times$ Species &  1   & 3.38   & 0.0659 \\
\hline
\end{tabular}

- Note that now the $\chi^2$ reference distribution is not informative regarding goodness-of-fit (it can only be used for the standard Poisson and binomial cases!)
- Also note that performing the same tests with the inappropriate binomial model would lead to the erroneous conclusion that the distinct dose-response curves model is necessary
- We may compute lethal concentrations (in this case, infection concentrations), i.e. the conidia concentration that infects 100\%$p$ insects, based on the estimated for $\hat\beta_{0i}$ and $\hat\beta_{1i}$
- Here, the median lethal concentrations are $10^{4.84}$ conidia per ml for \textit{Isaria fumosorosea} and $10^{6.25}$ conidia per ml for \textit{Beauveria bassiana}, showing that \textit{I. fumosorosea} is $10^{6.25}/10^{4.84}\approx25$ times as potent as \textit{B. bassiana}

## Fitted Curves -- Binomial Model

\centering
\includegraphics[width=.7\textwidth]{fitted_ribbon1.pdf}

## Fitted Curves -- Logistic-Normal Model

\centering
\includegraphics[width=.7\textwidth]{fitted_ribbon2.pdf}

## Summary

\footnotesize

\begin{itemize}
\item Statistical modelling depends on the biological processes
\item We only discussed examples with simple linear predictors
\item Different features of experimental/sampling design may add different terms to the model
\item It all depends on the objectives of study and research questions
\item Sometimes we may need to build on existing models or to develop new ones to model the data appropriately
\end{itemize}

## And last but not least...

\includegraphics[width = .8\textwidth]{assumptions.png}

## References

\footnotesize

\begin{itemize}
\item Demétrio, C.G.B., Hinde, J., Moral, R.A. (2014) Models for overdispersed data in Entomology. In Ferreira, C.P., Godoy, W.A.C. (Eds.) Ecological modelling applied to Entomology, Springer.
\item Moral, R.A., Hinde, J., Demétrio, C.G.B. (2017) Half-normal plots and overdispersed models in R: the hnp package. \textit{Journal of Statistical Software}, 81(10), 1--23.
\end{itemize}

## Extra Material (if we have time)

## A second example: \textit{D. citri} oviposition

\footnotesize

\begin{itemize}
\item In an experiment$^1$ to assess the effect of three agricultural oils on the oviposition of \textit{D. citri}, 70 Orange Jessamine (\textit{Murraya paniculata}) plants were spayed with solutions of the mineral oils Oppa and Iharol, and the vegetable oil Nortox
\item The experiment used the oils in concentrations of 0.5\% and 1.0\% and a control of plain water set out in a completely randomized design with 10 replicates
\item After the plants were dry, 10 \textit{D. citri} females were released on each plant
\item After five days, the insects were removed and the total number of eggs laid counted
\item Example of aggregated data
\end{itemize}

\scriptsize
$^1$Amaral FSA, Poltronieri AS, Alves EB, Omoto C (2012) Efeito de óleos agrícolas no comportamento de oviposição e viabilidade de ovos de Diaphorina citri Kuwayama (Hemiptera: Psyllidae). In: XX Simpósio Internacional de Iniciação Científica da Universidade de São Paulo, 2012, Pirassununga

## \textit{D. citri} oviposition

\centering
\includegraphics[width=\textwidth]{table2.png}

## Fitting the Poisson GLM

\footnotesize

\centering

\begin{tabular}{lccc}
\hline
Source & df & Deviance & p-value \\
\hline
Treatments & 6 & 944.35 & $<0.0001$ \\
\hline
\end{tabular}

\begin{itemize}
\item Residual deviance: 2523.10 on 63 df
\item Pearson $X^2$: 2290.85
\item $\chi^2_{63;0.95}=82.53$
\end{itemize}

## Assessing Goodness-of-fit (\textit{D. citri} oviposition data)

\centering
\includegraphics[width=\textwidth]{12oil_hnp.eps}

## Fitting the Negative Binomial Model

\footnotesize

\begin{itemize}
\item The change in the deviance for treatment is now 32.25 on 6 degrees of freedom ($p<0.0001$ as well)
\item We may decompose it into 3.30 on 5 df for the first 6 treatments and 28.95 on 1 df for Nortox at 1% concentration
\item The conclusion is clear that only 1\% Nortox is different, even allowing for extravariation of the negative binomial model
\item Note that performing the same tests with the inappropriate Poisson model would lead to the erroneous conclusion that there are significant differences between many of the treatments
\end{itemize}

## 95\% CI for the Linear Predictors

\centering
\includegraphics[width=.9\textwidth]{13oil_fit.eps}